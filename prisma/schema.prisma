// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl opsiyonel - sadece migration için gerekli
  // directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("admin") // admin, manager, viewer
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  producerApprovedScripts VoiceoverScript[] @relation("ProducerApprover")
  adminApprovedScripts    VoiceoverScript[] @relation("AdminApprover")

  @@map("users")
}

model Streamer {
  id             String   @id @default(cuid())
  name           String
  profilePhoto   String? // Profil fotoğrafı URL'si
  email          String?  @unique // Yayıncı login için email
  phone          String?
  iban           String? // IBAN bilgisi
  password       String? // Yayıncı login için şifre (hash'lenmiş)
  loginToken     String?  @unique // Yayıncı login için token (opsiyonel)
  channelUrl     String?
  hourlyRate     Float    @default(0) // Saat başı ücret
  commissionRate Float    @default(0) // Yüzde olarak
  isActive       Boolean  @default(true)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  streams           Stream[]
  externalStreams   ExternalStream[]
  payments          Payment[]
  financialRecords  FinancialRecord[]
  teamRates         StreamerTeamRate[] // Takım bazlı saatlik ücretler
  contentRegistries ContentRegistry[] // Seslendirmen olarak atandığı içerikler
  paymentRequests   PaymentRequest[]
  extraWorkRequests ExtraWorkRequest[]
}

model StreamerTeamRate {
  id         String   @id @default(cuid())
  streamerId String
  streamer   Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  teamName   String // Arhaval, Sangal, Eternal Fire, etc.
  hourlyRate Float // Bu takım için saat başı ücret
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([streamerId, teamName]) // Aynı yayıncı için aynı takım iki kez eklenemez
}

model Stream {
  id              String   @id @default(cuid())
  streamerId      String
  streamer        Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  date            DateTime
  duration        Int // Saat cinsinden (sadece tam saatler: 1, 2, 3, 4, 5...)
  matchInfo       String? // Hangi maç olduğu
  teamName        String? // Sangal, Eternal Fire, Arhaval - hangi takıma gittiği
  totalRevenue    Float    @default(0)
  streamerEarning Float    @default(0)
  arhavalProfit   Float    @default(0)
  teams           String? // JSON array (eski sistem)
  cost            Float    @default(0) // eski sistem
  status          String   @default("approved") // pending, approved, rejected - Yayıncılar yayınları girince direkt onaylanır
  paymentStatus   String   @default("pending") // pending, paid
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([streamerId])
  @@index([date])
  @@index([teamName])
  @@index([status])
}

model ExternalStream {
  id         String   @id @default(cuid())
  streamerId String
  streamer   Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  teamName   String
  date       DateTime
  duration   Int
  payment    Float
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ContentCreator {
  id           String   @id @default(cuid())
  name         String
  profilePhoto String?
  email        String?  @unique // İçerik üreticisi login için email
  phone        String?
  iban         String? // IBAN bilgisi
  password     String? // (hash'lenmiş)
  loginToken   String?  @unique
  platform     String?
  channelUrl   String?
  isActive     Boolean  @default(true)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  contents          Content[]
  scripts           VoiceoverScript[]
  financialRecords  FinancialRecord[]
  contentRegistries ContentRegistry[]
  paymentRequests   PaymentRequest[]
  extraWorkRequests ExtraWorkRequest[]
}

model Content {
  id          String          @id @default(cuid())
  title       String
  type        String // video, post, reel, story, etc.
  platform    String // Instagram, TikTok, YouTube, etc.
  url         String?
  publishDate DateTime
  creatorId   String?
  creator     ContentCreator? @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  creatorName String?

  views    Int @default(0)
  likes    Int @default(0)
  comments Int @default(0)
  shares   Int @default(0)
  saves    Int @default(0)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // İçerik Kayıt Sistemi bağlantısı
  contentRegistry ContentRegistry?
  paymentRequests PaymentRequest[]
}

model VoiceActor {
  id           String   @id @default(cuid())
  name         String
  profilePhoto String?
  email        String?  @unique
  phone        String?
  iban         String?
  password     String?
  loginToken   String?  @unique
  isActive     Boolean  @default(true)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  scripts           VoiceoverScript[]
  financialRecords  FinancialRecord[]
  contentRegistries ContentRegistry[]
  paymentRequests   PaymentRequest[]
  extraWorkRequests ExtraWorkRequest[]
}

enum VoiceoverScriptStatus {
  WAITING_VOICE // Ses bekleniyor
  VOICE_UPLOADED // Ses geldi - onay bekliyor
  APPROVED // Onaylandı
  REJECTED // Düzeltme istendi
  PAID // Ödemesi yapıldı
  ARCHIVED // Tamamlandı, aktif akıştan çıktı
}

model VoiceoverScript {
  id              String                @id @default(cuid())
  title           String
  text            String
  creatorId       String?
  creator         ContentCreator?       @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  voiceActorId    String?
  voiceActor      VoiceActor?           @relation(fields: [voiceActorId], references: [id], onDelete: SetNull)
  status          VoiceoverScriptStatus @default(WAITING_VOICE)
  audioFile       String? // Deprecated - use voiceLink
  voiceLink       String? // Ses linki (Google Drive vb.)
  price           Float? // Nullable - admin onayından önce boş olabilir
  contentType     String?
  notes           String?
  rejectionReason String? // REJECTED durumunda neden reddedildiği

  // Producer (İçerik Üreticisi) Onayı
  producerApproved   Boolean   @default(false)
  producerApprovedAt DateTime?
  producerApprovedBy String?
  producerApprover   User?     @relation("ProducerApprover", fields: [producerApprovedBy], references: [id], onDelete: SetNull)

  // Admin Onayı
  adminApproved   Boolean   @default(false)
  adminApprovedAt DateTime?
  adminApprovedBy String?
  adminApprover   User?     @relation("AdminApprover", fields: [adminApprovedBy], references: [id], onDelete: SetNull)

  // Relations
  editPack EditPack?
  
  // İçerik Kayıt Sistemi bağlantısı
  contentRegistry ContentRegistry?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FinancialRecord {
  id               String          @id @default(cuid())
  type             String // income, expense (deprecated, use entryType)
  category         String // salary, content, sponsorship, equipment, etc.
  amount           Float // Her zaman pozitif, direction ile OUT/IN ayrılır
  description      String?
  date             DateTime // Deprecated, use occurredAt
  occurredAt       DateTime        @default(now()) // Ödeme tarihi
  entryType        String          @default("expense") // payout, expense, income, adjustment
  direction        String          @default("OUT") // OUT (gider/ödeme), IN (gelir)
  streamerId       String?
  streamer         Streamer?       @relation(fields: [streamerId], references: [id])
  teamMemberId     String?
  teamMember       TeamMember?     @relation(fields: [teamMemberId], references: [id])
  contentCreatorId String?
  contentCreator   ContentCreator? @relation(fields: [contentCreatorId], references: [id])
  voiceActorId     String?
  voiceActor       VoiceActor?     @relation(fields: [voiceActorId], references: [id])
  streamId         String?
  relatedPaymentId String? // İlgili Payment/TeamPayment ID'si (varsa)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([date]) // Deprecated ama backward compatibility için
  @@index([occurredAt]) // Ana tarih field'ı
  @@index([type])
  @@index([entryType])
  @@index([entryType, occurredAt]) // Composite index - entryType + tarih sorguları için
  @@index([direction])
  @@index([streamerId])
  @@index([teamMemberId])
  @@index([contentCreatorId])
  @@index([voiceActorId])
  @@index([streamerId, occurredAt]) // Composite index - streamer + tarih sorguları için
  @@index([teamMemberId, occurredAt]) // Composite index - team member + tarih sorguları için
  @@index([contentCreatorId, occurredAt]) // Composite index - creator + tarih sorguları için
  @@index([voiceActorId, occurredAt]) // Composite index - voice actor + tarih sorguları için
  @@index([type, occurredAt]) // Composite index - type + tarih sorguları için (monthly filter optimize)
  @@index([date, occurredAt]) // Composite index - date ve occurredAt birlikte sorgular için
}

model Payment {
  id          String    @id @default(cuid())
  streamerId  String
  streamer    Streamer  @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  amount      Float
  type        String // salary, commission, bonus
  period      String // YYYY-MM
  description String?
  paidAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([streamerId])
  @@index([streamerId, paidAt])
  @@index([paidAt])
  @@index([period])
}

model TeamMember {
  id         String   @id @default(cuid())
  name       String
  avatar     String? // Profil fotoğrafı URL'si
  email      String?  @unique
  phone      String?
  password   String?
  iban       String?
  role       String
  baseSalary Float    @default(0)
  isActive   Boolean  @default(true)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tasks             Task[]
  payments          TeamPayment[]
  financialRecords  FinancialRecord[]
  contentRegistries ContentRegistry[] // Editör olarak atandığı içerikler
  paymentRequests   PaymentRequest[]
  extraWorkRequests ExtraWorkRequest[]
}

model Task {
  id           String     @id @default(cuid())
  teamMemberId String
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  title        String
  description  String?
  status       String     @default("pending")
  priority     String     @default("medium")
  dueDate      DateTime?
  completedAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model TeamPayment {
  id           String     @id @default(cuid())
  teamMemberId String
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  amount       Float
  type         String // salary, bonus, commission
  period       String // YYYY-MM
  description  String?
  paidAt       DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([teamMemberId])
  @@index([teamMemberId, paidAt])
  @@index([paidAt])
  @@index([period])
}

model Payout {
  id            String    @id @default(cuid())
  recipientType String // 'streamer' | 'voiceActor' | 'teamMember' | 'contentCreator'
  recipientId   String // Streamer/VoiceActor/TeamMember/ContentCreator ID
  amount        Float // Pozitif tutar
  status        String    @default("paid") // 'paid' | 'unpaid' | 'partial'
  source        String    @default("manual") // 'manual' | 'stream' | 'voice' | 'other'
  referenceId   String? // streamId/voiceJobId varsa
  note          String?
  paidAt        DateTime? // Ödeme tarihi
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([recipientType, recipientId])
  @@index([recipientType, recipientId, createdAt])
  @@index([status, createdAt])
  @@index([paidAt])
}

model MonthlyPlan {
  id        String   @id @default(cuid())
  title     String
  target    Float
  month     String // YYYY-MM
  type      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, month])
}

model YearlyGoal {
  id           String   @id @default(cuid())
  title        String
  target       Float
  year         Int
  type         String
  isCurrency   Boolean  @default(false)
  isPercentage Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([type, year])
}

model SocialMediaStats {
  id            String   @id @default(cuid())
  month         String?
  week          String?
  platform      String
  followerCount Int
  target        Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([month, week, platform])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String? // İşlemi yapan kullanıcı ID'si (User, Streamer, Creator, vb.)
  userName   String? // İşlemi yapan kullanıcı adı (hızlı erişim için)
  userRole   String? // Kullanıcı rolü (admin, streamer, creator, vb.)
  action     String // Yapılan işlem (payment_created, record_deleted, vb.)
  entityType String? // Hangi tablo (Payment, FinancialRecord, Stream, vb.)
  entityId   String? // İlgili kayıt ID'si
  oldValue   String? // Eski değer (JSON string - güncelleme için)
  newValue   String? // Yeni değer (JSON string - güncelleme için)
  details    String? // Detaylı bilgi (JSON string)
  ipAddress  String? // IP adresi (güvenlik için)
  userAgent  String? // Tarayıcı bilgisi
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([userRole])
}

model EditPack {
  id           String   @id @default(cuid())
  voiceoverId  String   @unique // 1 voiceover -> 1 edit pack
  voiceover    VoiceoverScript @relation(fields: [voiceoverId], references: [id], onDelete: Cascade)
  token        String   @unique // Random, unguessable token
  editorNotes  String?  // Nullable text
  assetsLinks  String?  // JSON array: [{label,url}]
  createdAt    DateTime @default(now())
  expiresAt    DateTime // createdAt + 7 days (NOT NULL)

  @@index([token])
  @@index([expiresAt])
  @@index([voiceoverId])
}

model Todo {
  id        String   @id @default(cuid())
  text      String
  completed Boolean  @default(false)
  notes     String?  // Notlar için alan
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([completed])
  @@index([createdAt])
}

// İçerik Kayıt Sistemi - Editör, Ses ve Üretici bağlantısı
enum ContentRegistryStatus {
  WAITING_SCRIPT  // Metin bekleniyor - içerik üreticisi metin yazacak
  DRAFT           // Taslak - henüz başlanmadı
  SCRIPT_READY    // Metin hazır - seslendirme bekliyor
  VOICE_READY     // Ses hazır - kurgu bekliyor
  EDITING         // Kurgu aşamasında
  REVIEW          // İnceleme bekliyor
  PUBLISHED       // Yayınlandı
  ARCHIVED        // Arşivlendi
}

model ContentRegistry {
  id          String                @id @default(cuid())
  title       String                // İçerik başlığı
  description String?               // Açıklama
  status      ContentRegistryStatus @default(DRAFT)
  
  // İçerik Üreticisi (Producer) bağlantısı
  creatorId   String?
  creator     ContentCreator?       @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  
  // Seslendirmen (Voice Actor) bağlantısı
  voiceActorId String?
  voiceActor   VoiceActor?          @relation(fields: [voiceActorId], references: [id], onDelete: SetNull)
  
  // Yayıncı seslendirmen olarak (Streamer as Voice Actor)
  streamerId   String?
  streamer     Streamer?            @relation(fields: [streamerId], references: [id], onDelete: SetNull)
  
  // Ödeme bilgileri
  voicePrice   Float?               // Seslendirme ücreti
  editPrice    Float?               // Kurgu ücreti
  voicePaid    Boolean              @default(false) // Seslendirme ödemesi yapıldı mı
  editPaid     Boolean              @default(false) // Kurgu ödemesi yapıldı mı
  
  // Editör (Team Member) bağlantısı
  editorId    String?
  editor      TeamMember?           @relation(fields: [editorId], references: [id], onDelete: SetNull)
  
  // İlişkili kayıtlar
  voiceoverScriptId String?         @unique // Seslendirme metni
  voiceoverScript   VoiceoverScript? @relation(fields: [voiceoverScriptId], references: [id], onDelete: SetNull)
  
  contentId   String?               @unique // Yayınlanan içerik
  content     Content?              @relation(fields: [contentId], references: [id], onDelete: SetNull)
  
  // İçerik detayları
  platform    String?               // YouTube, Instagram, TikTok, etc.
  contentType String?               // uzun, kısa, reels, shorts, etc.
  
  // Metin içeriği
  scriptText  String?               // İçerik üreticisinin yazdığı metin
  
  // Linkler
  scriptLink  String?               // Metin linki (Google Docs vb.)
  voiceLink   String?               // Ses linki (Google Drive vb.)
  editLink    String?               // Kurgu linki (Google Drive vb.)
  finalLink   String?               // Final video linki
  
  // Tarihler
  scriptDeadline DateTime?          // Metin teslim tarihi
  voiceDeadline  DateTime?          // Ses teslim tarihi
  editDeadline   DateTime?          // Kurgu teslim tarihi
  publishDate    DateTime?          // Yayın tarihi
  
  // Notlar
  notes       String?               // Genel notlar
  editorNotes String?               // Editör notları
  
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  
  paymentRequests PaymentRequest[]

  @@index([status])
  @@index([creatorId])
  @@index([voiceActorId])
  @@index([streamerId])
  @@index([editorId])
  @@index([platform])
  @@index([createdAt])
}

// Ödeme Talep Sistemi
enum PaymentRequestStatus {
  PENDING  // Beklemede
  APPROVED // Onaylandı
  REJECTED // Reddedildi
  PAID     // Ödendi
}

enum PaymentRequestType {
  CONTENT    // İçerik üretimi
  VOICE      // Seslendirme
  EDIT       // Kurgu/Montaj
  STREAM     // Yayın
  DESIGN     // Tasarım
  MANAGEMENT // Yönetim
  OTHER      // Diğer
}

model PaymentRequest {
  id          String               @id @default(cuid())
  
  // Talep eden kişi (sadece biri dolu olacak)
  contentCreatorId String?
  contentCreator   ContentCreator?  @relation(fields: [contentCreatorId], references: [id], onDelete: Cascade)
  
  voiceActorId     String?
  voiceActor       VoiceActor?      @relation(fields: [voiceActorId], references: [id], onDelete: Cascade)
  
  streamerId       String?
  streamer         Streamer?        @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  
  teamMemberId     String?
  teamMember       TeamMember?      @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  
  // Talep bilgileri
  type             PaymentRequestType   @default(OTHER)
  amount           Float
  description      String
  status           PaymentRequestStatus @default(PENDING)
  
  // İlgili içerik (opsiyonel)
  contentId        String?
  content          Content?         @relation(fields: [contentId], references: [id], onDelete: SetNull)
  
  contentRegistryId String?
  contentRegistry   ContentRegistry? @relation(fields: [contentRegistryId], references: [id], onDelete: SetNull)
  
  // Dosya/kanıt (opsiyonel)
  attachmentUrl    String?
  
  // Admin notları
  adminNotes       String?
  rejectionReason  String?
  
  // Tarihler
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  approvedAt       DateTime?
  paidAt           DateTime?
  
  @@index([contentCreatorId])
  @@index([voiceActorId])
  @@index([streamerId])
  @@index([teamMemberId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

// Ekstra İş Talep Sistemi
model ExtraWorkRequest {
  id          String   @id @default(cuid())
  
  // Talep eden kişi (sadece biri dolu olacak)
  contentCreatorId String?
  contentCreator   ContentCreator?  @relation(fields: [contentCreatorId], references: [id], onDelete: Cascade)
  
  voiceActorId     String?
  voiceActor       VoiceActor?      @relation(fields: [voiceActorId], references: [id], onDelete: Cascade)
  
  streamerId       String?
  streamer         Streamer?        @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  
  teamMemberId     String?
  teamMember       TeamMember?      @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  
  // Talep bilgileri
  workType         String   // VOICE, EDIT, STREAM, CONTENT, OTHER
  amount           Float
  description      String
  status           String   @default("pending") // pending, approved, rejected, paid
  
  // Admin notları
  adminNotes       String?
  
  // Tarihler
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([contentCreatorId])
  @@index([voiceActorId])
  @@index([streamerId])
  @@index([teamMemberId])
  @@index([status])
  @@index([createdAt])
}
