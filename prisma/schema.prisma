// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  // directUrl opsiyonel - sadece migration için gerekli
  // directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("admin") // admin, manager, viewer
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Streamer {
  id             String   @id @default(cuid())
  name           String
  profilePhoto   String?  // Profil fotoğrafı URL'si
  email          String?  @unique // Yayıncı login için email
  phone          String?
  iban           String?  // IBAN bilgisi
  password       String?  // Yayıncı login için şifre (hash'lenmiş)
  loginToken     String?  @unique // Yayıncı login için token (opsiyonel)
  channelUrl     String?
  hourlyRate     Float    @default(0) // Saat başı ücret
  commissionRate Float    @default(0) // Yüzde olarak
  isActive       Boolean  @default(true)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  streams          Stream[]
  externalStreams  ExternalStream[]
  payments         Payment[]
  financialRecords FinancialRecord[]
  teamRates        StreamerTeamRate[] // Takım bazlı saatlik ücretler
}

model StreamerTeamRate {
  id         String   @id @default(cuid())
  streamerId String
  streamer   Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  teamName   String   // Arhaval, Sangal, Eternal Fire, etc.
  hourlyRate Float    // Bu takım için saat başı ücret
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([streamerId, teamName]) // Aynı yayıncı için aynı takım iki kez eklenemez
}

model Stream {
  id              String   @id @default(cuid())
  streamerId      String
  streamer        Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  date            DateTime
  duration        Int      // Saat cinsinden (sadece tam saatler: 1, 2, 3, 4, 5...)
  matchInfo       String?  // Hangi maç olduğu
  teamName        String?  // Sangal, Eternal Fire, Arhaval - hangi takıma gittiği
  totalRevenue    Float    @default(0)
  streamerEarning Float    @default(0)
  arhavalProfit   Float    @default(0)
  teams           String?  // JSON array (eski sistem)
  cost            Float    @default(0) // eski sistem
  status          String   @default("approved") // pending, approved, rejected - Yayıncılar yayınları girince direkt onaylanır
  paymentStatus   String   @default("pending") // pending, paid
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([streamerId])
  @@index([date])
  @@index([teamName])
  @@index([status])
}

model ExternalStream {
  id         String   @id @default(cuid())
  streamerId String
  streamer   Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  teamName   String
  date       DateTime
  duration   Int
  payment    Float
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ContentCreator {
  id           String            @id @default(cuid())
  name         String
  profilePhoto String?
  email        String?           @unique // İçerik üreticisi login için email
  phone        String?
  iban         String?           // IBAN bilgisi
  password     String?           // (hash'lenmiş)
  loginToken   String?          @unique
  platform     String?
  channelUrl   String?
  isActive     Boolean           @default(true)
  notes        String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  contents         Content[]
  scripts          VoiceoverScript[]
  financialRecords FinancialRecord[]
}

model Content {
  id          String   @id @default(cuid())
  title       String
  type        String   // video, post, reel, story, etc.
  platform    String   // Instagram, TikTok, YouTube, etc.
  url         String?
  publishDate DateTime
  creatorId   String?
  creator     ContentCreator? @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  creatorName String?

  views    Int @default(0)
  likes    Int @default(0)
  comments Int @default(0)
  shares   Int @default(0)
  saves    Int @default(0)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VoiceActor {
  id           String            @id @default(cuid())
  name         String
  profilePhoto String?
  email        String?           @unique
  phone        String?
  iban         String?
  password     String?
  loginToken   String?           @unique
  isActive     Boolean           @default(true)
  notes        String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  scripts          VoiceoverScript[]
  financialRecords FinancialRecord[]
}

enum VoiceoverScriptStatus {
  WAITING_VOICE    // Ses bekleniyor
  VOICE_UPLOADED   // Ses geldi - onay bekliyor
  APPROVED         // Onaylandı
  REJECTED         // Düzeltme istendi
  PAID             // Ödemesi yapıldı
  ARCHIVED         // Tamamlandı, aktif akıştan çıktı
}

model VoiceoverScript {
  id           String   @id @default(cuid())
  title        String
  text         String
  creatorId    String?
  creator      ContentCreator? @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  voiceActorId String?
  voiceActor   VoiceActor? @relation(fields: [voiceActorId], references: [id], onDelete: SetNull)
  status       VoiceoverScriptStatus @default(WAITING_VOICE)
  audioFile    String?  // Deprecated - use voiceLink
  voiceLink    String?  // Ses linki (Google Drive vb.)
  price        Float?   // Nullable - admin onayından önce boş olabilir
  contentType  String?
  notes        String?
  rejectionReason String? // REJECTED durumunda neden reddedildiği
  
  // Producer (İçerik Üreticisi) Onayı
  producerApproved   Boolean   @default(false)
  producerApprovedAt DateTime?
  producerApprovedBy String?
  producerApprover   User?     @relation("ProducerApprover", fields: [producerApprovedBy], references: [id], onDelete: SetNull)
  
  // Admin Onayı
  adminApproved   Boolean   @default(false)
  adminApprovedAt DateTime?
  adminApprovedBy String?
  adminApprover   User?     @relation("AdminApprover", fields: [adminApprovedBy], references: [id], onDelete: SetNull)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model FinancialRecord {
  id               String          @id @default(cuid())
  type             String          // income, expense (deprecated, use entryType)
  category         String          // salary, content, sponsorship, equipment, etc.
  amount           Float           // Her zaman pozitif, direction ile OUT/IN ayrılır
  description      String?
  date             DateTime        // Deprecated, use occurredAt
  occurredAt       DateTime        @default(now()) // Ödeme tarihi
  entryType        String          @default("expense") // payout, expense, income, adjustment
  direction        String          @default("OUT") // OUT (gider/ödeme), IN (gelir)
  streamerId       String?
  streamer         Streamer?       @relation(fields: [streamerId], references: [id])
  teamMemberId     String?
  teamMember       TeamMember?     @relation(fields: [teamMemberId], references: [id])
  contentCreatorId String?
  contentCreator   ContentCreator? @relation(fields: [contentCreatorId], references: [id])
  voiceActorId     String?
  voiceActor       VoiceActor?     @relation(fields: [voiceActorId], references: [id])
  streamId         String?
  relatedPaymentId String?         // İlgili Payment/TeamPayment ID'si (varsa)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([date])
  @@index([occurredAt])
  @@index([type])
  @@index([entryType])
  @@index([entryType, occurredAt])
  @@index([direction])
  @@index([streamerId])
  @@index([teamMemberId])
  @@index([contentCreatorId])
  @@index([voiceActorId])
  @@index([streamerId, occurredAt])
  @@index([teamMemberId, occurredAt])
  @@index([contentCreatorId, occurredAt])
  @@index([voiceActorId, occurredAt])
}

model Payment {
  id          String   @id @default(cuid())
  streamerId  String
  streamer    Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  amount      Float
  type        String   // salary, commission, bonus
  period      String   // YYYY-MM
  description String?
  paidAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([streamerId])
  @@index([streamerId, paidAt])
  @@index([paidAt])
  @@index([period])
}

model TeamMember {
  id           String            @id @default(cuid())
  name         String
  avatar       String?           // Profil fotoğrafı URL'si
  email        String?           @unique
  phone        String?
  password     String?
  iban         String?
  role         String
  baseSalary   Float             @default(0)
  isActive     Boolean            @default(true)
  notes        String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  tasks            Task[]
  payments         TeamPayment[]
  financialRecords FinancialRecord[]
}

model Task {
  id           String     @id @default(cuid())
  teamMemberId String
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  title        String
  description  String?
  status       String     @default("pending")
  priority     String     @default("medium")
  dueDate      DateTime?
  completedAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model TeamPayment {
  id           String     @id @default(cuid())
  teamMemberId String
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  amount       Float
  type         String     // salary, bonus, commission
  period       String     // YYYY-MM
  description  String?
  paidAt       DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([teamMemberId])
  @@index([teamMemberId, paidAt])
  @@index([paidAt])
  @@index([period])
}

model Payout {
  id          String   @id @default(cuid())
  recipientType String // 'streamer' | 'voiceActor' | 'teamMember' | 'contentCreator'
  recipientId   String // Streamer/VoiceActor/TeamMember/ContentCreator ID
  amount      Float    // Pozitif tutar
  status      String   @default("paid") // 'paid' | 'unpaid' | 'partial'
  source      String   @default("manual") // 'manual' | 'stream' | 'voice' | 'other'
  referenceId String?  // streamId/voiceJobId varsa
  note        String?
  paidAt      DateTime? // Ödeme tarihi
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([recipientType, recipientId])
  @@index([recipientType, recipientId, createdAt])
  @@index([status, createdAt])
  @@index([paidAt])
}

model MonthlyPlan {
  id        String   @id @default(cuid())
  title     String
  target    Float
  month     String   // YYYY-MM
  type      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, month])
}

model YearlyGoal {
  id           String   @id @default(cuid())
  title        String
  target       Float
  year         Int
  type         String
  isCurrency   Boolean  @default(false)
  isPercentage Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([type, year])
}

model SocialMediaStats {
  id            String   @id @default(cuid())
  month         String?
  week          String?
  platform      String
  followerCount Int
  target        Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([month, week, platform])
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?  // İşlemi yapan kullanıcı ID'si (User, Streamer, Creator, vb.)
  userName    String?  // İşlemi yapan kullanıcı adı (hızlı erişim için)
  userRole    String?  // Kullanıcı rolü (admin, streamer, creator, vb.)
  action      String   // Yapılan işlem (payment_created, record_deleted, vb.)
  entityType  String?  // Hangi tablo (Payment, FinancialRecord, Stream, vb.)
  entityId    String?  // İlgili kayıt ID'si
  oldValue    String?  // Eski değer (JSON string - güncelleme için)
  newValue    String?  // Yeni değer (JSON string - güncelleme için)
  details     String?  // Detaylı bilgi (JSON string)
  ipAddress   String?  // IP adresi (güvenlik için)
  userAgent   String?  // Tarayıcı bilgisi
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([userRole])
}
